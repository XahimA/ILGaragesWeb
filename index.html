<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Garage QnA ‚Äì By S&I</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="wrap">
    <header class="glass">
      <h1>üîß Garage QnA</h1>
      <span class="pill">By S&I</span>
    </header>

    <div class="content">
      <section id="page1" class="glass card">
        <div class="page-header">
          <div class="page-title">Page 1 ‚Ä¢ Basics & Infrastructure</div>
        </div>

        <!-- Enhanced Image Upload Options -->
        <div class="toolbar" style="margin-bottom:16px">
          <div class="upload-options">
            <button id="btnTakePhoto">üì∑ Take Photo</button>
            <button id="btnChooseFromGallery">üñºÔ∏è Choose from Gallery</button>
          </div>
          <button class="secondary" id="btnSelectLocation">üìç Location</button>
        </div>

        <div class="form-group">
          <label class="req">Garage Name / SAP Code</label>
          <input id="garage_name" type="text" placeholder="Enter garage name or SAP code" />
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label class="req">Body Shop Bays</label>
            <select id="body_shop_bays">
              <option value="">Select</option>
              <option>None</option>
              <option>2</option>
              <option>3</option>
              <option>More than 3</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Flooring Type</label>
            <select id="flooring_type">
              <option value="">Select</option>
              <option>Unfinished</option>
              <option>Paver Block</option>
              <option>Concrete</option>
              <option>Epoxy</option>
            </select>
          </div>
        </div>

        <h3>Infrastructure Questions</h3>
        <div id="infrastructure_container"></div>

        <!-- New Questionnaire: Painting Consumable -->
        <h3>Painting Consumable</h3>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="masking_tape" name="painting_consumable">
            Masking Tape
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="masking_paper" name="painting_consumable">
            Masking Paper
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="plastic_primer" name="painting_consumable">
            Plastic Primer
          </label>
        </div>

        <!-- New Questionnaire: A/C Gas Machine -->
        <h3>A/C Gas Machine</h3>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="ac_gas_machine" value="Only Recharge">
            Only Recharge
          </label>
          <label class="radio-label">
            <input type="radio" name="ac_gas_machine" value="Recharge & Recovery Both">
            Recharge & Recovery Both
          </label>
          <label class="radio-label">
            <input type="radio" name="ac_gas_machine" value="External vendor Tie up">
            External vendor Tie up
          </label>
        </div>

        <!-- New Questionnaire: Washing Equipment -->
        <h3>Washing Equipment</h3>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="washing_equipment" value="Tie up with external vendor">
            Tie up with external vendor
          </label>
          <label class="radio-label">
            <input type="radio" name="washing_equipment" value="Inhouse Equipment">
            Inhouse Equipment
          </label>
        </div>

        <!-- Camera Setting Challenge -->
        <h3>Camera Setting Challenge</h3>
        <div class="form-group">
          <label>Any camera setting challenges faced?</label>
          <textarea id="camera_challenge" placeholder="Describe any camera-related issues..." rows="3"></textarea>
        </div>

        <h3>Images (Minimum 5 Required)</h3>
        <div class="image-upload-area">
          <div class="upload-icon">üì∏</div>
          <div style="font-weight:600; margin-bottom:4px">Upload Photos</div>
          <div class="hint" style="justify-content:center">Name, Bays, Lounge, Selfie, Paint booth</div>
          <div class="hint" style="justify-content:center; margin-top:4px">
            <span style="color:var(--accent); font-weight:600">Selected: <span id="image_count">0</span></span>
          </div>
        </div>
        <div class="images" id="image_list"></div>

        <div class="hint" id="loc_hint">üìç Location: Not set</div>

        <div class="pages">
          <div class="steps">
            <span class="dot active"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
          <button id="next1">Next ‚Üí</button>
        </div>
      </section>

      <section id="page2" class="glass card" hidden>
        <div class="page-header">
          <div class="page-title">Page 2 ‚Ä¢ Tools & Safety</div>
        </div>

        <h3>Tools & Equipment Availability</h3>
        <div id="tools_container"></div>

        <h3>Equipment Details</h3>
        <div class="grid-2">
          <div class="form-group">
            <label class="req">Welding Equipment</label>
            <select id="welding_equipment">
              <option value="">Select</option>
              <option>Gas Welding</option>
              <option>MIG Welding</option>
              <option>Spot Welding</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Cutting Equipment</label>
            <select id="cutting_equipment">
              <option value="">Select</option>
              <option>Gas Cutter</option>
              <option>Plasma Cutter</option>
              <option>Pneumatic Cutter</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Windshield Remover</label>
            <select id="windshield_remover">
              <option value="">Select</option>
              <option>Manually by wire</option>
              <option>Windshield cutting equipment</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Paint Material</label>
            <select id="paint_material">
              <option value="">Select</option>
              <option>Asian PPG</option>
              <option>2K</option>
              <option>DuPont</option>
              <option>Axalta</option>
              <option>Nippon</option>
              <option>BASF</option>
              <option>Glasurit</option>
              <option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Paint Booth Type</label>
            <select id="paint_booth_type">
              <option value="">Select</option>
              <option>Water-borne</option>
              <option>Solvent-borne</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Car-O-Liner</label>
            <select id="car_o_liner">
              <option value="">Select</option>
              <option>Local Made</option>
              <option>Hydraulic</option>
              <option>Pneumatic</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Employment Type</label>
            <select id="employment_type">
              <option value="">Select</option>
              <option>Salaried</option>
              <option>Contract</option>
              <option>Both</option>
            </select>
          </div>
        </div>

        <h3>Safety Equipment</h3>
        <div id="safety_container" class="checkbox-group"></div>

        <h3>Customer Convenience</h3>
        <div class="form-group">
          <label class="req">Customer Lounge Available</label>
          <div id="customer_lounge_radio" class="yn"></div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label class="req">Pickup/Drop Distance</label>
            <select id="pickup_drop_distance">
              <option value="">Select</option>
              <option>None</option>
              <option>Within city (10 km)</option>
              <option>Within city (15 km)</option>
              <option>Within city (20 km)</option>
              <option>More than 20 km</option>
            </select>
          </div>
          <div class="form-group">
            <label class="req">Technician Certification</label>
            <select id="technician_certification">
              <option value="">Select</option>
              <option>&lt;50%</option>
              <option>50%</option>
              <option>55%</option>
              <option>75%</option>
              <option>100%</option>
            </select>
          </div>
        </div>

        <div class="pages">
          <button id="prev2" class="secondary">‚Üê Previous</button>
          <div class="steps">
            <span class="dot"></span>
            <span class="dot active"></span>
            <span class="dot"></span>
          </div>
          <button id="next2">Next ‚Üí</button>
        </div>
      </section>

      <section id="page3" class="glass card" hidden>
        <div class="page-header">
          <div class="page-title">Page 3 ‚Ä¢ LR Variables & Submit</div>
        </div>

        <h3>LR Variables</h3>
        <div class="grid-3">
          <div class="form-group">
            <label class="req">Repair Percentage</label>
            <input id="repair_percent" type="number" placeholder="e.g., 65" min="0" max="100" />
          </div>
          <div class="form-group">
            <label class="req">ACS</label>
            <input id="acs" type="number" placeholder="e.g., 12" min="0" />
          </div>
          <div class="form-group">
            <label class="req">Discount Rate</label>
            <input id="discount_rate" type="number" placeholder="e.g., 5" min="0" max="100" />
          </div>
        </div>

        <div class="form-group">
          <label class="req">Address</label>
          <textarea id="address" placeholder="Enter full address"></textarea>
        </div>

        <div class="pages">
          <button id="prev3" class="secondary">‚Üê Previous</button>
          <div class="steps">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot active"></span>
          </div>
          <button id="submit" class="success">‚úì Submit Form</button>
        </div>
      </section>
    </div>
  </div>

  <dialog id="mapDialog">
    <div class="dlgHead">
      <div class="dlgTitle">üìç Select Location</div>
      <button id="closeMap" class="secondary">‚úï</button>
    </div>
    <div class="dlgBody">
      <div id="map" class="map"></div>
      <div class="toolbar" style="margin-top:12px">
        <button id="useCurrent">üìç Use Current</button>
        <button id="confirmMap" class="success">‚úì Confirm</button>
      </div>
      <div class="hint" style="margin-top:8px">Tap map to place marker, then drag to adjust position</div>
    </div>
  </dialog>

  <dialog id="uploadDialog">
    <div class="dlgHead">
      <div class="dlgTitle">üì§ Uploading to Azure...</div>
    </div>
    <div class="dlgBody">
      <div id="uploadStatus">Preparing upload...</div>
      <div class="progress-bar">
        <div id="uploadProgress" class="progress-fill"></div>
      </div>
      <div class="hint" id="uploadDetail">Starting upload process</div>
    </div>
  </dialog>

  <dialog id="jsonDialog">
    <div class="dlgHead">
      <div class="dlgTitle">‚úÖ Form Submitted Successfully</div>
      <button id="closeJson" class="secondary">‚úï</button>
    </div>
    <div class="dlgBody">
      <pre class="json" id="jsonOut"></pre>
      <div class="toolbar" style="margin-top:12px">
        <button id="copyJson">üìã Copy JSON</button>
        <button id="newForm" class="success">üîÑ New Form</button>
      </div>
      <div class="hint" style="margin-top:8px">Data successfully Uploaded to Azure Blob Storage and Cosmos DB</div>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

  <!-- Multiple file inputs for different capture modes -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" multiple hidden />
  <input id="galleryInput" type="file" accept="image/*" multiple hidden />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
const AZURE_CONFIG = {
  STORAGE_ACCOUNT: "${AZURE_STORAGE_ACCOUNT}",
  STORAGE_KEY: "${AZURE_STORAGE_KEY}",
  CONTAINER_NAME: "${AZURE_CONTAINER_NAME}",
  COSMOS_ENDPOINT: "${COSMOS_ENDPOINT}",
  COSMOS_KEY: "${COSMOS_KEY}",
  DATABASE_NAME: "${DATABASE_NAME}",
  COSMOS_CONTAINER: "${COSMOS_CONTAINER}"
};

const REQUIRED_MIN_IMAGES = 5;

const state = {
  images: [],
  location: {lat:null, long:null, address:""},
  page: 1,
  isUploading: false
};

const $ = sel => document.querySelector(sel);
const el = (tag, props={}, ...children)=>{
  const n = Object.assign(document.createElement(tag), props);
  children.flat().forEach(c => n.append(c instanceof Node ? c : document.createTextNode(c)));
  return n;
};

const toast = (msg, type = 'info')=>{
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  t.className = 'toast';
  if (type === 'error') t.style.borderColor = 'var(--bad)';
  else if (type === 'success') t.style.borderColor = 'var(--ok)';
  else t.style.borderColor = 'var(--stroke)';
  clearTimeout(t._tid);
  t._tid = setTimeout(()=> t.style.display='none', 3000);
};

function generateCosmosAuthToken(verb, resourceType, resourceLink, key, date) {
  const CryptoJS = window.CryptoJS;
  const text = (verb || '').toLowerCase() + '\n' +
               (resourceType || '').toLowerCase() + '\n' +
               (resourceLink || '') + '\n' +
               (date || '').toLowerCase() + '\n\n';
  const keyBytes = CryptoJS.enc.Base64.parse(key);
  const signature = CryptoJS.HmacSHA256(text, keyBytes);
  const base64Sig = CryptoJS.enc.Base64.stringify(signature);
  const auth = encodeURIComponent(`type=master&ver=1.0&sig=${base64Sig}`);
  return auth;
}

function createSharedKeyAuth(method, blobName, contentLength, msDate) {
  const stringToSign = `${method}\n\n\n${contentLength}\n\nimage/jpeg\n\n\n\n\n\n\nx-ms-blob-type:BlockBlob\nx-ms-date:${msDate}\nx-ms-version:2020-04-08\n/${AZURE_CONFIG.STORAGE_ACCOUNT}/${AZURE_CONFIG.CONTAINER_NAME}/${blobName}`;
  const signature = btoa(stringToSign);
  return `SharedKey ${AZURE_CONFIG.STORAGE_ACCOUNT}:${signature}`;
}

const SAS_TOKEN = "sv=2024-11-04&ss=bfqt&srt=sco&sp=rwdlacupiytfx&se=2026-11-09T15:52:35Z&st=2025-11-09T07:37:35Z&spr=https,http&sig=E7PNOOM5qOpWIQqcddkRWpxcsv%2B0Ss%2FXNO8fy6FU5gE%3D";

function getBlobSasUrl(blobName) {
  const encodedBlobName = encodeURIComponent(blobName).replace(/'/g, "%27");
  return `https://${AZURE_CONFIG.STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_CONFIG.CONTAINER_NAME}/${encodedBlobName}?${SAS_TOKEN}`;
}

async function uploadImageToBlob(file, index) {
  try {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    const fileExtension = file.name.split('.').pop() || 'jpg';
    const blobName = `garage_${timestamp}_${random}_${index}.${fileExtension}`;
    const sasUrl = getBlobSasUrl(blobName);
    const blob = new Blob([file], { type: file.type || 'image/jpeg' });
    const response = await fetch(sasUrl, {
      method: 'PUT',
      headers: {
        'x-ms-blob-type': 'BlockBlob',
        'Content-Type': file.type || 'image/jpeg',
        'x-ms-version': '2020-04-08',
        'Content-Length': blob.size.toString()
      },
      body: blob
    });
    if (!response.ok) {
      const errorText = await response.text().catch(() => 'No error details');
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    if (response.status === 201) {
      return `https://${AZURE_CONFIG.STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_CONFIG.CONTAINER_NAME}/${blobName}`;
    } else {
      throw new Error(`Unexpected response status: ${response.status}`);
    }
  } catch (error) {
    throw new Error(`Failed to upload image: ${error.message}`);
  }
}

async function uploadToCosmosDB(document) {
  try {
    const cosmosUrl = `${AZURE_CONFIG.COSMOS_ENDPOINT}dbs/${AZURE_CONFIG.DATABASE_NAME}/colls/${AZURE_CONFIG.COSMOS_CONTAINER}/docs`;
    const dateFormat = new Date().toUTCString();
    const resourceLink = `dbs/${AZURE_CONFIG.DATABASE_NAME}/colls/${AZURE_CONFIG.COSMOS_CONTAINER}`;
    const authToken = generateCosmosAuthToken(
      'POST',
      'docs',
      resourceLink,
      AZURE_CONFIG.COSMOS_KEY,
      dateFormat
    );
    const partitionKeyValue = document.garageName || document.id || 'default';
    const partitionKeyHeader = `["${partitionKeyValue}"]`;
    document._uploadMetadata = {
      cosmosUploadTime: new Date().toISOString(),
      version: '1.0',
      source: 'web-form'
    };
    const response = await fetch(cosmosUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-ms-version': '2018-12-31',
        'x-ms-date': dateFormat,
        'x-ms-documentdb-partitionkey': partitionKeyHeader,
        'Authorization': authToken
      },
      body: JSON.stringify(document)
    });
    if (response.status === 201) {
      return true;
    } else {
      const errorText = await response.text();
      throw new Error(`Cosmos DB: ${response.status} - ${errorText}`);
    }
  } catch (error) {
    throw error;
  }
}

async function testAzureConnection() {
  try {
    const testBlobName = `test_connection_${Date.now()}.txt`;
    const testSasUrl = getBlobSasUrl(testBlobName);
    const testContent = "Test connection";
    const response = await fetch(testSasUrl, {
      method: 'PUT',
      headers: {
        'x-ms-blob-type': 'BlockBlob',
        'Content-Type': 'text/plain',
        'x-ms-version': '2020-04-08'
      },
      body: testContent
    });
    if (response.status === 201) {
      return true;
    } else {
      return false;
    }
  } catch (error) {
    return false;
  }
}

async function uploadFormData() {
  if (state.isUploading) return;
  state.isUploading = true;
  const uploadDialog = $('#uploadDialog');
  const uploadStatus = $('#uploadStatus');
  const uploadProgress = $('#uploadProgress');
  const uploadDetail = $('#uploadDetail');
  uploadDialog.showModal();
  try {
    const validation = validate();
    if (!validation.ok) {
      throw new Error('Form validation failed: ' + (validation.message || 'Please check all required fields'));
    }
    uploadStatus.textContent = 'Testing Azure connection...';
    uploadDetail.textContent = 'Verifying storage account access';
    const connectionTest = await testAzureConnection();
    if (!connectionTest) {
      throw new Error('Cannot connect to Azure Storage. Please check your SAS token and container permissions.');
    }
    const formData = collect();
    uploadStatus.textContent = 'Uploading images to Azure Blob Storage...';
    uploadDetail.textContent = `Preparing ${state.images.length} images`;
    const imageUrls = [];
    let successCount = 0;
    let failCount = 0;
    for (let i = 0; i < state.images.length; i++) {
      try {
        uploadDetail.textContent = `Uploading image ${i + 1}/${state.images.length}...`;
        const imageUrl = await uploadImageToBlob(state.images[i].file, i);
        imageUrls.push({
          url: imageUrl,
          fileName: state.images[i].name,
          uploadedAt: new Date().toISOString(),
          size: state.images[i].file.size
        });
        successCount++;
        uploadProgress.style.width = `${((i + 1) / state.images.length) * 50}%`;
      } catch (error) {
        failCount++;
        imageUrls.push({
          url: null,
          fileName: state.images[i].name,
          error: error.message,
          uploadedAt: new Date().toISOString()
        });
      }
    }
    formData.images = imageUrls;
    formData.uploadSummary = {
      total: state.images.length,
      successful: successCount,
      failed: failCount,
      uploadedAt: new Date().toISOString()
    };
    uploadProgress.style.width = '75%';
    uploadStatus.textContent = 'Uploading form data to Cosmos DB...';
    uploadDetail.textContent = 'Saving form submission...';
    const cosmosResult = await uploadToCosmosDB(formData);
    if (cosmosResult) {
      uploadProgress.style.width = '100%';
      uploadStatus.textContent = 'Upload completed successfully!';
      uploadDetail.textContent = `Images: ${successCount} successful, ${failCount} failed`;
      setTimeout(() => {
        uploadDialog.close();
        showSuccessDialog(formData);
        state.isUploading = false;
      }, 1500);
    } else {
      throw new Error('Failed to save data to Cosmos DB');
    }
  } catch (error) {
    uploadStatus.textContent = 'Upload failed';
    uploadDetail.textContent = error.message;
    uploadProgress.style.background = 'var(--bad)';
    setTimeout(() => {
      uploadDialog.close();
      toast(`Upload failed: ${error.message}`, 'error');
      state.isUploading = false;
    }, 3000);
  }
}

function showSuccessDialog(formData) {
  const jsonDialog = $('#jsonDialog');
  $('#jsonOut').textContent = JSON.stringify(formData, null, 2);
  jsonDialog.showModal();
}

const showPage = (p)=>{
  state.page = p;
  $('#page1').hidden = p!==1;
  $('#page2').hidden = p!==2;
  $('#page3').hidden = p!==3;
  window.scrollTo({top: 0, behavior: 'smooth'});
};

function chipYN(label, groupId){
  const wrap = el('div', {className:'yn', role:'radiogroup'});
  wrap.dataset.id = groupId;
  const yes = el('div', {className:'chip ok', role:'radio', tabIndex:0}, '‚úì Yes');
  const no = el('div', {className:'chip bad', role:'radio', tabIndex:0}, '‚úó No');
  yes.dataset.val = 'Yes';
  no.dataset.val = 'No';
  [yes,no].forEach(c=>{
    c.addEventListener('click', ()=>{
      [...wrap.children].forEach(x=>{
        x.classList.remove('active');
        x.setAttribute('aria-checked', 'false');
      });
      c.classList.add('active');
      c.setAttribute('aria-checked', 'true');
    });
    c.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ c.click(); e.preventDefault(); }
    });
  });
  wrap.append(yes,no);
  return wrap;
}

const infraQuestions = [
  'Paint Mixing Room Available',
  'Paint Booth Available'
];

const toolsQuestions = [
  'Dent Puller Available',
  'Sander Set Available',
  'Spray Gun Available',
  'Polishing Machine Available',
  "Tinker's Tool Kit Available",
  'Fiber / Plastic Repair Kit Available',
  'Dust Extraction Unit'
];

const safetyOptions = [
  'Safety Shoes','Gloves','Goggles','Mask','Coveralls','Ear Protection',
  'Fire Extinguishers','First Aid','Training Conducted'
];

function addYNList(containerId, questions){
  const cont = document.getElementById(containerId);
  questions.forEach(q=>{
    const row = el('div', {className:'question-row'},
      el('div', {className:'question-label'}, '‚Ä¢ ', q),
      chipYN(q, q)
    );
    cont.append(row);
  });
}

function buildSafety(){
  const cont = $('#safety_container');
  safetyOptions.forEach(opt=>{
    const id = 'safe_'+opt.replace(/[^a-z0-9]+/gi,'_').toLowerCase();
    const label = el('label', {className:'checkbox-label', htmlFor:id});
    const cb = el('input', {type:'checkbox', id});
    label.append(cb, opt);
    cont.append(label);
  });
}

// Enhanced image upload functionality
const cameraInput = $('#cameraInput');
const galleryInput = $('#galleryInput');

$('#btnTakePhoto').addEventListener('click', ()=> {
  cameraInput.click();
});

$('#btnChooseFromGallery').addEventListener('click', ()=> {
  galleryInput.click();
});

function handleFileSelection(files) {
  if(!files.length) return;
  for (const f of files){
    const url = URL.createObjectURL(f);
    state.images.push({file:f, url, name:f.name});
  }
  renderImages();
  toast(`${files.length} image(s) added. Total: ${state.images.length}`);
}

cameraInput.addEventListener('change', (e)=> {
  handleFileSelection([...(e.target.files||[])]);
  cameraInput.value = '';
});

galleryInput.addEventListener('change', (e)=> {
  handleFileSelection([...(e.target.files||[])]);
  galleryInput.value = '';
});

function renderImages(){
  const list = $('#image_list');
  const count = $('#image_count');
  list.innerHTML = '';
  count.textContent = state.images.length;
  state.images.forEach((img, i)=>{
    const item = el('div', {className:'imgItem'},
      el('img', {className:'thumb', src: img.url, alt: 'Image '+(i+1)}),
      el('div', {className:'grow'},
        el('div', {style:'font-weight:600'}, 'üì∑ Image ', (i+1)),
        el('div', {className:'muted', style:'font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap'},
          img.name || 'Image')
      ),
      el('button', {className:'danger', onclick: ()=>{
        URL.revokeObjectURL(img.url);
        state.images.splice(i,1);
        renderImages();
        toast(`Image removed. Total: ${state.images.length}`);
      }}, '‚úï')
    );
    list.append(item);
  });
}

let map, marker;
const mapDlg = $('#mapDialog');
const locHint = $('#loc_hint');

function ensureMap(start){
  if(map) {
    map.invalidateSize();
    if(start) map.setView(start, 15);
    return;
  }
  map = L.map('map',{zoomControl:true}).setView(start || [19.2969,73.0631], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,
    attribution:'¬© OpenStreetMap'
  }).addTo(map);
  marker = L.marker(start || [19.2969,73.0631], {draggable:true}).addTo(map);
  marker.on('dragend', ()=>{
    const p = marker.getLatLng();
    state.location.lat = +p.lat.toFixed(6);
    state.location.long = +p.lng.toFixed(6);
    updateLocHint();
  });
  map.on('click',(e)=>{
    marker.setLatLng(e.latlng);
    state.location.lat = +e.latlng.lat.toFixed(6);
    state.location.long = +e.latlng.lng.toFixed(6);
    updateLocHint();
  });
}

function updateLocHint(){
  if(state.location.lat!=null && state.location.long!=null){
    locHint.innerHTML = `üìç <strong>Lat:</strong> ${state.location.lat.toFixed(6)}, <strong>Long:</strong> ${state.location.long.toFixed(6)}`;
  }else{
    locHint.textContent = 'üìç Location: Not set';
  }
}

$('#btnSelectLocation').addEventListener('click', ()=>{
  const start = (state.location.lat!=null && state.location.long!=null)
    ? [state.location.lat, state.location.long]
    : [19.2969, 73.0631];
  mapDlg.showModal();
  setTimeout(()=> ensureMap(start), 50);
});

$('#closeMap').addEventListener('click', ()=> mapDlg.close());

$('#confirmMap').addEventListener('click', ()=>{
  if(!state.location.lat || !state.location.long){
    toast('‚ö†Ô∏è Tap map to set a marker first');
    return;
  }
  mapDlg.close();
  toast('‚úì Location selected successfully');
});

$('#useCurrent').addEventListener('click', ()=>{
  if(!navigator.geolocation){
    toast('‚ö†Ô∏è Geolocation not supported');
    return;
  }
  toast('üìç Getting your location...');
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    state.location.lat = +latitude.toFixed(6);
    state.location.long = +longitude.toFixed(6);
    ensureMap([latitude, longitude]);
    marker.setLatLng([latitude, longitude]);
    map.setView([latitude, longitude], 15);
    updateLocHint();
    toast('‚úì Location captured successfully');
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
      .then(r => r.json())
      .then(data => {
        if(data && data.display_name){
          state.location.address = data.display_name;
          $('#address').value = data.display_name;
        }
      })
      .catch(()=>{});
  }, ()=>{
    toast('‚ö†Ô∏è Unable to get location. Please select manually.');
  }, {enableHighAccuracy:true, timeout:10000});
});

function validatePage(pageNumber) {
  const missing = [];
  const missingYN = [];
  const checkYN = (question) => {
    const wrap = document.querySelector(`.yn[data-id="${question}"]`);
    if (!wrap) return false;
    const hasActive = wrap.querySelector('.chip.active');
    return !!hasActive;
  };
  const highlightMissing = (questions) => {
    questions.forEach(q => {
      const wrap = document.querySelector(`.yn[data-id="${q}"]`);
      if (wrap) {
        wrap.style.outline = '2px solid var(--bad)';
        wrap.style.outlineOffset = '4px';
        wrap.style.borderRadius = '12px';
        setTimeout(() => {
          wrap.style.outline = '';
          wrap.style.outlineOffset = '';
        }, 2000);
      }
    });
  };
  if (pageNumber === 1) {
    if (!$('#garage_name').value.trim()) missing.push('Garage Name');
    if (!$('#body_shop_bays').value) missing.push('Body Shop Bays');
    if (!$('#flooring_type').value) missing.push('Flooring Type');
    infraQuestions.forEach(q => {
      if (!checkYN(q)) missingYN.push(q);
    });
    if (state.images.length < REQUIRED_MIN_IMAGES) {
      toast(`‚ö†Ô∏è Please add at least ${REQUIRED_MIN_IMAGES} photos`, 'error');
      return false;
    }
    if (state.location.lat == null || state.location.long == null) {
      toast('‚ö†Ô∏è Please select location on the map', 'error');
      return false;
    }
  }
  if (pageNumber === 2) {
    const fields = [
      'welding_equipment', 'cutting_equipment', 'windshield_remover',
      'paint_material', 'paint_booth_type', 'car_o_liner',
      'employment_type', 'pickup_drop_distance', 'technician_certification'
    ];
    fields.forEach(id => {
      if (!$(`#${id}`).value) {
        missing.push(id.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
      }
    });
    toolsQuestions.forEach(q => {
      if (!checkYN(q)) missingYN.push(q);
    });
    if (!checkYN('Customer Lounge Available')) {
      missingYN.push('Customer Lounge Available');
    }
  }
  if (pageNumber === 3) {
    const rp = $('#repair_percent').value;
    const acs = $('#acs').value;
    const dr = $('#discount_rate').value;
    if (!rp || isNaN(rp)) missing.push('Repair Percentage');
    if (!acs || isNaN(acs)) missing.push('ACS');
    if (!dr || isNaN(dr)) missing.push('Discount Rate');
    if (!$('#address').value.trim()) missing.push('Address');
  }
  if (missing.length > 0 || missingYN.length > 0) {
    let errorMsg = '‚ö†Ô∏è Please complete the following:\n\n';
    if (missing.length > 0) {
      errorMsg += 'Fields:\n‚Ä¢ ' + missing.join('\n‚Ä¢ ') + '\n\n';
    }
    if (missingYN.length > 0) {
      errorMsg += 'Yes/No Questions:\n‚Ä¢ ' + missingYN.join('\n‚Ä¢ ');
      highlightMissing(missingYN);
    }
    alert(errorMsg);
    return false;
  }
  return true;
}

function validate() {
  return {ok: validatePage(state.page)};
}

$('#next1').addEventListener('click', () => {
  if (validatePage(1)) showPage(2);
});

$('#next2').addEventListener('click', () => {
  if (validatePage(2)) showPage(3);
});

$('#submit').addEventListener('click', async (e) => {
  e.preventDefault();
  if (validatePage(3)) {
    await uploadFormData();
  }
});

function collect(){
  const getYN = (q)=>{
    const wrap = document.querySelector(`.yn[data-id="${q}"]`);
    if (!wrap) return 'Not answered';
    const chip = wrap.querySelector('.chip.active');
    return chip ? chip.dataset.val : 'Not answered';
  };
  
  const getRadioValue = (name) => {
    const selected = document.querySelector(`input[name="${name}"]:checked`);
    return selected ? selected.value : 'Not answered';
  };

  const getCheckboxValues = (name) => {
    const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
    return Array.from(checkboxes).map(cb => cb.parentElement.textContent.trim());
  };

  const infra = {};
  infraQuestions.forEach(q=> infra[q] = getYN(q));
  const tools = {};
  toolsQuestions.forEach(q=> tools[q] = getYN(q));
  const safety = [];
  document.querySelectorAll('#safety_container input[type="checkbox"]').forEach(cb=>{
    if(cb.checked){
      const label = cb.parentElement.textContent.trim();
      safety.push(label);
    }
  });

  const formData = {
    id: crypto.randomUUID ? crypto.randomUUID() : 'id-' + Date.now(),
    submittedAt: new Date().toISOString(),
    garageName: $('#garage_name').value.trim(),
    infrastructureDetails: infra,
    toolsEquipmentDetails: tools,
    
    // New questionnaires
    paintingConsumable: getCheckboxValues('painting_consumable'),
    acGasMachine: getRadioValue('ac_gas_machine'),
    washingEquipment: getRadioValue('washing_equipment'),
    cameraSettingChallenge: $('#camera_challenge').value.trim(),
    
    bodyShopBays: $('#body_shop_bays').value.trim(),
    flooringType: $('#flooring_type').value.trim(),
    weldingEquipment: $('#welding_equipment').value.trim(),
    cuttingEquipment: $('#cutting_equipment').value.trim(),
    paintMaterial: $('#paint_material').value.trim(),
    paintBoothType: $('#paint_booth_type').value.trim(),
    carOLiner: $('#car_o_liner').value.trim(),
    employmentType: $('#employment_type').value.trim(),
    windshieldRemover: $('#windshield_remover').value.trim(),
    safetyEquipment: safety,
    customerLoungeAvailable: getYN('Customer Lounge Available'),
    pickupDropDistance: $('#pickup_drop_distance').value.trim(),
    technicianCertification: $('#technician_certification').value.trim(),
    repairPercent: $('#repair_percent').value.trim(),
    acs: $('#acs').value.trim(),
    discountRate: $('#discount_rate').value.trim(),
    location: {
      lat: state.location.lat,
      long: state.location.long,
      address: $('#address').value.trim()
    },
    images: []
  };
  return formData;
}

function clearForm() {
  document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el => {
    el.value = '';
  });
  document.querySelectorAll('.chip.active').forEach(chip => {
    chip.classList.remove('active');
    chip.setAttribute('aria-checked', 'false');
  });
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.checked = false;
  });
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  state.images.forEach(img => URL.revokeObjectURL(img.url));
  state.images = [];
  renderImages();
  state.location = {lat: null, long: null, address: ""};
  updateLocHint();
  showPage(1);
  toast('Form cleared. Ready for new entry.', 'success');
}

$('#prev2').addEventListener('click', ()=> showPage(1));
$('#prev3').addEventListener('click', ()=> showPage(2));

$('#closeJson').addEventListener('click', ()=> $('#jsonDialog').close());

$('#copyJson').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText($('#jsonOut').textContent);
    toast('‚úì JSON copied to clipboard', 'success');
  }catch{
    toast('‚ö†Ô∏è Copy failed', 'error');
  }
});

$('#newForm').addEventListener('click', () => {
  $('#jsonDialog').close();
  clearForm();
});

addYNList('infrastructure_container', infraQuestions);
addYNList('tools_container', toolsQuestions);
$('#customer_lounge_radio').append(chipYN('Customer Lounge Available','Customer Lounge Available'));
buildSafety();
updateLocHint();
  </script>
</body>
</html>